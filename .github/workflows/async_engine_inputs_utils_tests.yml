name: Async Engine, Inputs, Utils, Worker Test

on:
  push:
    branches:
      - run_test251211
  #   paths:
  #     - 'vllm/**'
  #     - 'tests/test_inputs.py'
  #     - 'tests/test_outputs.py'
  #     - 'tests/multimodal/**'
  #     - 'tests/utils_/**'
  #     - 'tests/standalone_tests/lazy_imports.py'
  #     - 'tests/transformers_utils/**'
  # pull_request:
  #   paths:
  #     - 'vllm/**'
  #     - 'tests/test_inputs.py'
  #     - 'tests/test_outputs.py'
  #     - 'tests/multimodal/**'
  #     - 'tests/utils_/**'
  #     - 'tests/standalone_tests/lazy_imports.py'
  #     - 'tests/transformers_utils/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  # compile-vllm:
  #   uses: ./.github/workflows/reusable-compile-vllm.yml
  #   with:
  #     python-version: "3.12"
  #     cache-dir: "/home/flagscale_cicd/sccache_cache"
  #     cmake-parallel-level: 4

  amd-experimental-test:
    # needs: compile-vllm
    runs-on: self-hosted
    # runs-on: [ self-hosted, amdexperimental ]
    defaults:
      run:
        shell: bash
    container:
      image: localhost:5000/flagos:vllm-cuda-amd64-test-20251216
      ports:
        - 80:80
      volumes:
        - /home/flagscale_cicd/docker/docker_build/docker_tokenizers:/home/gitlab-runner/tokenizers
        - /home/flagscale_cicd/docker/docker_build/docker_data:/home/gitlab-runner/data
      options: >-
        --gpus all
        --shm-size=500g
        --privileged
        --ipc=host
        --ulimit memlock=-1
        --ulimit stack=67108864
        --ulimit nofile=65535:65535
        --user root

    env:
      PYTHONUNBUFFERED: "1"  # 实时打印Python日志
      PYTEST_ADDOPTS: "-v -s"  # 统一pytest参数，减少重复

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6.0.1
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          ssh-strict: true
          ssh-user: git
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true

      - name: Pre-Check Environment
        timeout-minutes: 5
        run: |
          echo "===== System Info ====="
          uname -a
          python3 --version || python --version
          pip3 --version || pip --version

          echo "===== GPU Info ====="
          if command -v nvidia-smi &>/dev/null; then
            nvidia-smi
          else
            echo "⚠️ GPU check skipped. nvidia-smi is not available in the current environment."
          fi

          echo "===== Disk Space ====="
          df -h

          echo "===== Available memory ====="
          free -h

          echo "python3_path: $(which python3)"

      # - uses: astral-sh/setup-uv@v7
      #   with:
      #     enable-cache: true
      #     cache-dependency-glob: |
      #       requirements/**/*.txt
      #       pyproject.toml
      #     python-version: '3.12'

      # - name: Create virtual environment
      #   run: |
      #     uv venv
      #     echo "$GITHUB_WORKSPACE/.venv/bin" >> "$GITHUB_PATH"
      #     # # 重新安装vLLM (复用编译产物, 不会重新编译)
      #     # uv pip install -e . -vvv

      # - name: Install dependencies and build vLLM
      #   run: |
      #     uv pip install -r requirements/cuda.txt --index-strategy unsafe-best-match
      #     uv pip install -e . -vvv
      #   env:
      #     CMAKE_BUILD_PARALLEL_LEVEL: 4
    
      # - name: Verify installation
      #   shell: bash
      #   run: |
      #     python3 -c "import vllm; print(f'vLLM version: {vllm.__version__}')"

      # - name: GPU Usage Check / Verification
      #   run: |
      #     source .github/workflows/scripts/gpu_check.sh
      #     wait_for_gpu

      - name: Run lazy imports test
        run: |
          echo "python3_path0: $(which python3)"
          echo "python3_path1: $(which python3)"
          python3 tests/standalone_tests/lazy_imports.py
          # /usr/bin/python3
        continue-on-error: false  # 懒加载测试是基础，失败直接终止

      # - name: Run test_inputs.py
      #   run: pytest -v -s tests/test_inputs.py

      # - name: Run test_outputs.py
      #   run: pytest -v -s tests/test_outputs.py

      # - name: Run multimodal tests
      #   run: pytest -v -s tests/multimodal

      # - name: Run utils_ tests
      #   run: pytest -v -s tests/utils_

      # - name: Run transformers_utils tests
      #   run: pytest -v -s tests/transformers_utils

      - name: Perform batch execution of pytest tests
        run: |
          pytest tests/test_inputs.py
          pytest tests/test_outputs.py
          pytest tests/multimodal
          pytest tests/utils_
          pytest tests/transformers_utils
        # 可选：单个测试失败不终止，便于查看所有失败用例
        continue-on-error: true
