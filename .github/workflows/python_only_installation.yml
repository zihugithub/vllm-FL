name: Python-only Installation Test

on:
  push:
    branches:
      - run_test251211
    # paths:
    #   - 'tests/standalone_tests/python_only_compile.sh'
    #   - 'setup.py'
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - 'tests/standalone_tests/python_only_compile.sh'
  #     - 'setup.py'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  python-only-install-test:
    runs-on: self-hosted
    # runs-on: [ self-hosted, amdexperimental ]
    defaults:
      run:
        shell: bash
    container:
      image: localhost:5000/flagos:vllm-cuda-amd64-test-20251216
      # ports:
      #   - 80:80
      volumes:
        - /home/flagscale_cicd/docker/docker_build/docker_tokenizers:/home/gitlab-runner/tokenizers
        - /home/flagscale_cicd/docker/docker_build/docker_data:/home/gitlab-runner/data
        - /home/yefubao/tmp/pip-cache:/root/.cache/pip
        - /home/yefubao/tmp/vllm-install-logs:/var/log/vllm-install
      options: >-
        --gpus all 
        --shm-size=500g 
        --privileged 
        --ipc=host 
        --ulimit memlock=-1 
        --ulimit stack=67108864 
        --ulimit nofile=65535:65535 
        --user root

    env:
      PYTHONUNBUFFERED: "1"          # ç¦ç”¨Pythonè¾“å‡ºç¼“å†²ï¼Œå®æ—¶æ‰“å°å®‰è£…æ—¥å¿—
      PIP_DEFAULT_TIMEOUT: "180"     # å»¶é•¿pipè¶…æ—¶ï¼Œé¿å…å¤§ä¾èµ–åŒ…ä¸‹è½½å¤±è´¥
      PIP_NO_CACHE_DIR: "0"          # å¯ç”¨pipç¼“å­˜ï¼ˆé…åˆæŒ‚è½½çš„ç¼“å­˜ç›®å½•ï¼‰
      PIP_PROGRESS_BAR: "on"         # æ–°å¢ï¼šæ˜¾ç¤ºpipä¸‹è½½è¿›åº¦
      LC_ALL: "C.UTF-8"              # æ–°å¢ï¼šç»Ÿä¸€å­—ç¬¦ç¼–ç ï¼Œé¿å…localeé—®é¢˜
      LANG: "C.UTF-8"
      # æ–°å¢ï¼šç¼–è¯‘ç›¸å…³ä¼˜åŒ–ï¼ŒåŠ é€Ÿå®‰è£…
      CMAKE_BUILD_PARALLEL_LEVEL: "8"
      MAX_JOBS: "8"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6.0.1
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          ssh-strict: true
          ssh-user: git
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true
          fetch-depth: 10 # æ–°å¢ï¼šæ·±åº¦æ‹‰å–ï¼Œé¿å…æµ…å…‹éš†å¯¼è‡´çš„è„šæœ¬æ‰§è¡Œé—®é¢˜

      - name: Pre-Check Environment
        timeout-minutes: 5
        run: |
          set -euo pipefail  # æ–°å¢ï¼šä¸¥æ ¼æ¨¡å¼ï¼Œä»»ä½•é”™è¯¯ç«‹å³ç»ˆæ­¢
          echo "===== System Info ====="
          uname -a
          python3 --version || (echo "âŒ python3 not found"; exit 1)
          pip3 --version || (echo "âŒ pip3 not found"; exit 1)

          echo "===== GPU Info ====="
          if command -v nvidia-smi &>/dev/null; then
            nvidia-smi --query-gpu=index,name,memory.total,utilization.gpu --format=csv
          else
            echo "âš ï¸ GPU check skipped. nvidia-smi is not available in the current environment."
            exit 1
          fi

          nvcc --version || echo "âš ï¸ nvcc not found (non-fatal for python-only install)"

          echo "===== Disk Space ====="
          df -h

          echo "===== Available memory ====="
          free -h

          echo "===== æŒ‚è½½ç›®å½•æ£€æŸ¥ ====="
          [ -d "/home/gitlab-runner/tokenizers" ] || echo "âš ï¸ tokenizersç›®å½•æœªæŒ‚è½½"
          [ -d "/home/gitlab-runner/data" ] || echo "âš ï¸ dataç›®å½•æœªæŒ‚è½½"
          [ -d "/root/.cache/pip" ] || mkdir -p /root/.cache/pip
          [ -d "/var/log/vllm-install" ] || mkdir -p /var/log/vllm-install

      - name: Python-only Installation Test
        # timeout-minutes: 40
        working-directory: tests
        run: |
          set -euo pipefail
          echo "===== å¼€å§‹æ‰§è¡ŒPython-onlyå®‰è£…è„šæœ¬ [$(date)] ====="
          # å®šä¹‰æ—¥å¿—è·¯å¾„ï¼Œæ–¹ä¾¿åç»­æ’æŸ¥
          LOG_FILE="/var/log/vllm-install/python_only_compile_$(date +%Y%m%d_%H%M%S).log"
          
          # æ‰§è¡Œè„šæœ¬å¹¶è®°å½•å®Œæ•´æ—¥å¿—
          bash tests/standalone_tests/python_only_compile.sh > "$LOG_FILE" 2>&1

          # å®æ—¶æ‰“å°æ—¥å¿—ï¼ˆå…¼é¡¾å®æ—¶æ€§å’ŒæŒä¹…åŒ–ï¼‰
          tail -f "$LOG_FILE" &
          TAIL_PID=$!
          wait $! || (echo "âŒ å®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥"; cat "$LOG_FILE"; kill $TAIL_PID; exit 1)

          echo "===== å®‰è£…è„šæœ¬æ‰§è¡ŒæˆåŠŸ [$(date)] ====="
          # æ–°å¢ï¼šéªŒè¯å®‰è£…ç»“æœ
          python3 -c "import vllm; print(f'âœ… vLLMå®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: {vllm.__version__}')" || {
            echo "âŒ vLLMå¯¼å…¥å¤±è´¥ï¼Œæ—¥å¿—å†…å®¹:"
            cat "$LOG_FILE"
            exit 1
          }
      - name: Post-Install Verification (æ–°å¢)
        if: always()  # å³ä½¿å®‰è£…å¤±è´¥ä¹Ÿæ‰§è¡Œï¼Œä¿ç•™è°ƒè¯•ä¿¡æ¯
        run: |
          echo "===== å®‰è£…åéªŒè¯ä¿¡æ¯ ====="
          # æ‰“å°å…³é”®æ—¥å¿—ç‰‡æ®µ
          LOG_DIR="/var/log/vllm-install"
          if [ -f "$LOG_DIR"/*.log ]; then
            echo "ğŸ“œ æœ€å100è¡Œå®‰è£…æ—¥å¿—:"
            tail -100 "$LOG_DIR"/*.log
          fi
          
          # æ‰“å°å·²å®‰è£…çš„åŒ…åˆ—è¡¨
          echo "ğŸ“¦ å·²å®‰è£…çš„PythonåŒ… (vllmç›¸å…³):"
          pip3 list | grep -E "(vllm|torch|cuda)" || true

      - name: Upload Installation Logs (æ–°å¢)
        if: always()  # å¤±è´¥æ—¶ä¹Ÿä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: vllm-install-logs-${{ github.run_id }}
          path: /var/log/vllm-install/
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©ï¼Œé¿å…å­˜å‚¨æº¢å‡º
          if-no-files-found: warn
