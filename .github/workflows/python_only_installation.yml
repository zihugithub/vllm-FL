name: Python-only Installation Test

on:
  push:
    branches:
      - main
    # paths:
    #   - 'tests/standalone_tests/python_only_compile.sh'
    #   - 'setup.py'
  # pull_request:
  #   branches:
  #     - main
  #   paths:
  #     - 'tests/standalone_tests/python_only_compile.sh'
  #     - 'setup.py'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  ubuntu-gpu-smoke-test:
    runs-on: self-hosted
    # runs-on: [ self-hosted, amdexperimental ]
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }} # 统一工作目录为仓库根目录，避免路径混乱
    container:
      image: localhost:5000/flagos:vllm-cuda-amd64-test-20251216
      # ports:
      #   - 80:80
      volumes:
        - /home/flagscale_cicd/docker/docker_build/docker_tokenizers:/home/gitlab-runner/tokenizers
        - /home/flagscale_cicd/docker/docker_build/docker_data:/home/gitlab-runner/data
        - /home/yefubao/tmp/pip-cache:/root/.cache/pip
      options: >-
        --gpus all 
        --shm-size=500g 
        --privileged 
        --ipc=host 
        --ulimit memlock=-1 
        --ulimit stack=67108864 
        --ulimit nofile=65535:65535 
        --user root

    env:
      PYTHONUNBUFFERED: "1"          # 禁用Python输出缓冲，实时打印安装日志
      PIP_DEFAULT_TIMEOUT: "180"     # 延长pip超时，避免大依赖包下载失败
      PIP_NO_CACHE_DIR: "0"          # 启用pip缓存（配合挂载的缓存目录）

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6.0.1
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          ssh-strict: true
          ssh-user: git
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          # set-safe-directory: true
          set-safe-directory: ${{ github.workspace }}

      - name: Pre-Check Environment
        timeout-minutes: 5
        run: |
          set -e
          echo "===== System Info ====="
          uname -a
          python3 --version || python --version
          pip3 --version || pip --version

          echo "===== GPU Info ====="
          if command -v nvidia-smi &>/dev/null; then
            nvidia-smi
          else
            echo "⚠️ GPU check skipped. nvidia-smi is not available in the current environment."
            exit 1
          fi

          echo "===== Disk Space ====="
          df -h

          echo "===== Available memory ====="
          free -h

          echo "===== 挂载目录检查 ====="
          [ -d "/home/gitlab-runner/tokenizers" ] || echo "⚠️ tokenizers目录未挂载"
          [ -d "/home/gitlab-runner/data" ] || echo "⚠️ data目录未挂载"
          [ -d "/root/.cache/pip" ] || mkdir -p /root/.cache/pip

      - name: Python-only Installation Test
        # timeout-minutes: 40
        working-directory: tests
        run: |
          echo "===== 开始执行安装脚本 ====="
          bash standalone_tests/python_only_compile.sh
